{% extends "databruce/base.html" %}
{% load filters %}
{% block title %}
  {{ song_info.name }}
{% endblock title %}
{% block content %}
  <div class="row mb-2">
    <h4>
      <a href="{% url 'databruce:songs' %}">Songs</a> &gt; {{ song_info.name }}
    </h4>
  </div>
  <div class="row mb-4 row-cols-1 row-cols-md-2 g-4 mt-0">
    <div class="col">
      <div class="card h-100">
        <h5 class="card-header">Song Info</h5>
        <div class="card-body">
          <div class="row justify-content-start">
            <div class="col-auto pe-0 fs-6 fw-semibold">Original Artist:</div>
            <div class="col">{{ song_info.original_artist|default_if_none:"Bruce Springsteen" }}</div>
          </div>
          {% if release %}
            <div class="row justify-content-start">
              <div class="col-auto pe-0 fs-6 fw-semibold">First Release:</div>
              <div class="col">
                <a href="{% url "databruce:release_details" id=release.release.id %}">{{ release.release.name }}</a>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <h5 class="card-header">Song Stats</h5>
        <div class="card-body">
          <div class="row justify-content-start">
            <div class="col-auto pe-0 fs-6 fw-semibold">Public:</div>
            <div class="col">{{ song_info.num_plays_public }}</div>
          </div>
          <div class="row justify-content-start">
            <div class="col-auto pe-0 fs-6">Private:</div>
            <div class="col">{{ song_info.num_plays_private }}</div>
          </div>
          <div class="row justify-content-start">
            <div class="col-auto pe-0 fs-6">Frequency:</div>
            <div class="col">{{ frequency }}%</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <h5 class="card-header">Performances</h5>
        <div class="card-body px-0">
          <div class="table-responsive p-0">
            <table class="table table display" id="songTable">
              <thead>
                <tr>
                  <th class="all" scope="col">Date</th>
                  <th class="all" scope="col">Act</th>
                  <th class="min-tablet-l" scope="col">Tour</th>
                  <th class="min-tablet-l" scope="col">Position</th>
                  <th class="min-tablet-l" scope="col">Venue</th>
                  <th class="min-tablet-l" scope="col">Gap</th>
                  <th class="min-tablet-l" scope="col">Set</th>
                  <th class="min-tablet-l" scope="col">Prev</th>
                  <th class="min-tablet-l" scope="col">Next</th>
                  <th class="min-tablet-l" scope="col">Note</th>
                </tr>
              </thead>
              <tbody>
                {% for song in songs %}
                  <tr>
                    <td class="text-nowrap">
                      <a href="{% url "databruce:event_details" event=song.current.event.id %}">{{ song.current.event }}</a>
                    </td>
                    <td>
                      <a href="{% url "databruce:band_details" id=song.current.event.artist.id %}">{{ song.current.event.artist }}</a>
                    </td>
                    <td>
                      {% if song.current.event.tour %}{{ song.current.event.tour }}{% endif %}
                    </td>
                    <td>
                      {% if song.current.position and song.current.position != song.current.set_name %}
                        {{ song.current.position }}
                      {% endif %}
                    </td>
                    <td>
                      {% with venue=song.current.event.venue %}
                        <a href="{% url 'databruce:venue_details' id=venue.id %}">
                          {% spaceless %}
                            {% if venue.city %}
                              {{ venue.name }}, {{ venue.city }}
                            {% else %}
                              {{ venue.name }}
                            {% endif %}
                          {% endspaceless %}
                        </a>
                      {% endwith %}
                    </td>
                    <td>
                      {% if song.current.premiere %}
                        first
                      {% else %}
                        {{ song.current.last|default_if_none:"" }}
                      {% endif %}
                    </td>
                    <td>{{ song.current.set_name }}</td>
                    <td class="text-wrap">
                      {% if song.prev %}
                        <a href="{% url "databruce:song_details" id=song.prev.song.id %}">{{ song.prev.song.short_name|default_if_none:song.prev.song.name }}</a>
                      {% else %}
                        <em>***</em>
                      {% endif %}
                    </td>
                    <td class="text-wrap">
                      {% if song.next %}
                        <a href="{% url "databruce:song_details" id=song.next.song.id %}">{{ song.next.song.short_name|default_if_none:song.next.song.name }}</a>
                      {% else %}
                        <em>***</em>
                      {% endif %}
                    </td>
                    <td class="text-wrap">{{ song.current.song_note|default_if_none:"" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // removes searchBuilder button, not needed for this.
    layout.topEnd.features[1].buttons[0].config.columns = [0, 1, 2, 3, 6, 7, 8]

    $(document).ready(function () {
      new DataTable('#songTable', {
        layout: layout,
        initComplete: function () {
          this.api()
          .columns([5])
            .every(function () {
              var column = this;

              $('<div class="row g-3 align-items-center"><div class="col-auto"><label for="publicity">Publicity:</label></div><div class="col" id="publicity-select"></div></div>').appendTo($('#dropdown-container'));
  
              // this appears to be the only way to add a select filter
              // without going through ajax calls. I originally had a pre-made dropdown in
              // another file and included it like above, however, I had to use an ajax call
              // otherwise it would appear but not work
              var select = $('<select id="publicity" class="custom-select form-select form-select-sm"></select>')
                .appendTo($('#publicity-select'))
                .on('change', function () {
                    column
                      .search($(this).val(), {regex: true})
                      .draw();
                });
              
              
              select.append('<option value=".*">All</option>');
              select.append('<option value="(Soundcheck|Rehearsal|Recording)">Private</option>');
              select.append('<option value="^(?!.*(Soundcheck|Rehearsal|Recording)).*$">Public</option>');
            });
        },
      });
    });
  </script>
{% endblock content %}
