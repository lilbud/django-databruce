{% extends "databruce/base.html" %}
{% block title %}
  {{ song_info.name }}
{% endblock title %}
{% block extrajs %}
  <link href="https://cdn.datatables.net/columncontrol/1.0.7/css/columnControl.dataTables.min.css"
        rel="stylesheet">
  <script src="https://cdn.datatables.net/columncontrol/1.0.7/js/dataTables.columnControl.min.js"></script>
{% endblock extrajs %}
{% block content %}
  <div class="d-grid gap-0 row-gap-2">
    <div class="row" id="song-info">
      <div class="text-2xl text-wrap">{{ song_info.name }}</div>
    </div>
    <div class="row">
      <div class="col">
        <div class="text-lg">
          <div class="d-grid gap-0 row-gap-1">
            {% if song_info.album %}
              <div class="row">
                <div class="fw-semibold">Album</div>
                <div>
                  <a href="{% url "release_details" id=song_info.album.id %}">{{ song_info.category }}</a>
                </div>
              </div>
            {% endif %}
            <div class="row">
              <div class="fw-semibold">Original Artist</div>
              <div>{{ song_info.original_artist }}</div>
            </div>
            <div class="row">
              <div class="col col-lg-1">
                <div class="fw-semibold">
                  Public:
                  <i class="bi bi-info-circle-fill"
                     data-bs-toggle="tooltip"
                     data-bs-html="true"
                     data-bs-title="Number of times a song was played publicly. Meaning it was played at a show open to the public, not a soundcheck/private rehearsal"></i>
                </div>
                <div>{{ counts.public }}</div>
              </div>
              <div class="col col-lg-1">
                <div class="fw-semibold">
                  Private:
                  <i class="bi bi-info-circle-fill"
                     data-bs-toggle="tooltip"
                     data-bs-html="true"
                     data-bs-title="Number of times a song was played privately. Meaning at a closed rehearsal/soundcheck."></i>
                </div>
                <div>{{ counts.private }}</div>
              </div>
            </div>
            <div class="row">
              {% if song_info.last %}
                <div class="fw-semibold">Last Played:</div>
                <div>
                  <a href="{% url "event_details" id=song_info.last.id %}">{{ song_info.last.get_date }}</a>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <ul class="nav nav-pills items-end mb-2" role="tablist">
          <button class="nav-link text-center active mb-1 mb-md-0"
                  data-bs-toggle="pill"
                  data-bs-target="#events"
                  aria-controls="pills-events">Performances</button>
          {% if snippet_count > 0 %}
            <button class="nav-link text-center mb-1 mb-md-0"
                    data-bs-toggle="pill"
                    data-bs-target="#snippets"
                    aria-controls="pills-snippets">Snippets</button>
          {% endif %}
          <button class="nav-link text-center mb-1 mb-md-0"
                  data-bs-toggle="pill"
                  data-bs-target="#stats"
                  aria-controls="pills-stats">Stats</button>
          <button class="nav-link text-center mb-1 mb-md-0"
                  data-bs-toggle="pill"
                  data-bs-target="#yearstats"
                  aria-controls="pills-stats">Year by Year</button>
          {% if lyrics %}
            <button class="nav-link text-center mb-1 mb-md-0"
                    data-bs-toggle="pill"
                    data-bs-target="#lyrics"
                    aria-controls="pills-stats">Lyrics</button>
          {% endif %}
          <button class="nav-link text-center mb-1 mb-md-0"
                  data-bs-toggle="pill"
                  data-bs-target="#links"
                  aria-controls="pills-links">Links</button>
        </ul>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-12 mx-auto">
      <div class="tab-content">
        <div id="stats" class="tab-pane fade">
          <div class="card mb-3">
            <div class="card-header">Song Stats</div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col">
                  <div class="text-lg pb-2">Performance Stats</div>
                  <div class="row row-cols-1 row-cols-lg-4 g-2">
                    <div class="col">
                      <div class="card">
                        <div class="card-body">
                          <div class="text-sm text-nowrap">
                            Public
                            <i class="bi bi-info-circle-fill"
                               data-bs-toggle="tooltip"
                               data-bs-html="true"
                               data-bs-title="Number of times a song was played publicly. Meaning it was played at a show open to the public, not a soundcheck/private rehearsal"></i>
                          </div>
                          <div class="text-xl">{{ counts.public }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="card">
                        <div class="card-body">
                          <div class="text-sm text-nowrap">
                            Private
                            <i class="bi bi-info-circle-fill"
                               data-bs-toggle="tooltip"
                               data-bs-html="true"
                               data-bs-title="Number of times a song was played privately. Meaning at a closed rehearsal/soundcheck."></i>
                          </div>
                          <div class="text-xl">{{ counts.private }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="card">
                        <div class="card-body">
                          <div class="text-sm text-nowrap">
                            Snippet
                            <i class="bi bi-info-circle-fill"
                               data-bs-toggle="tooltip"
                               data-bs-html="true"
                               data-bs-title="Number of times a song was included as part of another."></i>
                          </div>
                          <div class="text-xl">{{ snippet_count }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="card">
                        <div class="card-body">
                          <div class="text-sm text-nowrap">
                            Frequency
                            <i class="bi bi-info-circle-fill"
                               data-bs-toggle="tooltip"
                               data-bs-html="true"
                               data-bs-title="How common a song is. Number of times played divided by number of shows since the debut. Formula from Dripfield.pro."></i>
                          </div>
                          <div class="text-xl">{{ frequency|default_if_none:"0" }}%</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% if positions %}
                <div class="row">
                  <div class="col">
                    <div class="text-lg pb-2">Position Stats</div>
                    <div class="row row-cols-1 row-cols-lg-4 g-2">
                      {% for item in positions %}
                        <div class="col">
                          <div class="card">
                            <div class="card-body">
                              <div class="text-sm text-nowrap">{{ item.position }}</div>
                              <div class="text-xl">{{ item.count }}</div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        <div id="events" class="tab-pane fade show active">
          <div class="card mb-3">
            <div class="card-body px-0">
              <div class="table-responsive">
                <table class="table table-hover display" id="songTable">
                  <thead>
                    <tr>
                      <th class="all" scope="col">Date</th>
                      <th class="min-tablet-l" scope="col">Act</th>
                      <th class="all" scope="col">Venue</th>
                      <th class="min-tablet-l" scope="col">Location</th>
                      <th class="min-tablet-l" scope="col">Tour</th>
                      <th class="min-tablet-l" scope="col">Position</th>
                      <th class="min-tablet-l" scope="col">Gap</th>
                      <th class="min-tablet-l" scope="col">Set</th>
                      <th class="min-tablet-l" scope="col">Prev</th>
                      <th class="min-tablet-l" scope="col">Next</th>
                      <th class="min-tablet-l" scope="col">Note</th>
                      <th class="min-tablet-l text-nowrap" scope="col">Public</th>
                    </tr>
                  </thead>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div id="snippets" class="tab-pane fade">
          <div class="card mb-3">
            <div class="card-header">Snippets</div>
            <div class="card-body px-0">
              <div class="table-responsive">
                <table class="table table-hover display" id="snippetTable">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>During Song</th>
                      <th>Note</th>
                    </tr>
                  </thead>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div id="links" class="tab-pane fade">
          <div class="card">
            <div class="card-header">Links</div>
            <div class="card-body">
              <ul class="mb-1">
                {% if song_info.brucebase_url %}
                  <li>
                    <a class=" "
                       href="https://brucebase.wikidot.com{{ song_info.brucebase_url }}">Brucebase</a>
                  </li>
                {% endif %}
                {% if song_info.spotify_id %}
                  <li>
                    <a class=" "
                       href="https://open.spotify.com/track/{{ song_info.spotify_id }}">Spotify</a>
                  </li>
                {% endif %}
                {% if song_info.mbid %}
                  <li>
                    <a class=" " href="https://musicbrainz.org/work/{{ song_info.mbid }}">Musicbrainz</a>
                  </li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
        <div id="yearstats" class="tab-pane fade">
          <div class="card mb-3">
            <div class="card-header">Year Stats</div>
            <div class="card-body">
              <div id="wrapper" class="p-0">
                <div id="statChart">
                  <canvas id="chart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="lyrics" class="tab-pane fade">
          <div class="card">
            <div class="card-header">Lyrics</div>
            <div class="card-body text-sm">
              {% for lyric in lyrics %}
                {% if lyric.language == 'English' and lyric.version == song_info.category %}{{ lyric.text|linebreaks }}{% endif %}
              {% endfor %}
              {% if lyrics.count > 1 %}
                <div class="text-base">Other Versions</div>
                <ul>
                  {% for lyric in lyrics %}
                    {% if lyric.language != 'English' %}
                      <div class="text-base">
                        <li>
                          <a class=" " href="{% url "lyric_detail" id=lyric.uuid %}">
                            {{ lyric.language }}
                            {% if lyric.note %}[{{ lyric.note }}]{% endif %}
                          </a>
                        </li>
                      </div>
                    {% endif %}
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- charts.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
  <script>
    $(document).ready(function () {
        let ctx = document.getElementById("chart").getContext("2d");
        Chart.defaults.color = '#999';

        var style = getComputedStyle(document.body);
        var primCol = style.getPropertyValue('--primary');

        console.log(primCol);

        let chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: [{% for year in year_stats %}{{year.year|date:"Y"}},{% endfor %}],
            datasets: [
                {
                  label: "Events",
                  backgroundColor: `${primCol}`,
                  borderColor: `${primCol}`,
                  color: "#ffffff",
                  data: [{% for year in year_stats %}{{year.event_count}},{% endfor %}]
                }
            ]
          },
          options: {
            responsive: true,
            title: {
                text: "Plays by Year",
                display: true
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: '#5e5e5e',
                },
              },
              x:{ 
                grid: {
                  color: '#5e5e5e',
                },
              },
            },
          },
        });

    });

    $(document).ready(function () {

      var layout = getDatatableLayout({columns: [0,1,2,3,4,5,6,7,8,9,10], category: true});
      var categories = [{'label': 'Public', 'value': '^Show|Set|Encore|Pre-Show$'}, {'label': 'Private', 'value': '^Soundcheck|Rehearsal|Recording|Interview$'}]
      
      dtCategorySelect({layout: layout, column_idx: 7, values: categories});

      new DataTable('#songTable', {
        layout: layout,
        serverSide: true,
        processing: true,
        ajax: {
          'url': '/api/v1/songspage/?song={{ song_info.id }}&format=datatables',
        },
        columnDefs: [
          { 'targets': [-1], 'visible': false },
          { 'targets': '_all', 'className': 'text-wrap', defaultContent: '' },
        ],
        columns: [
          {
            'data': 'event.date',
            'name': 'event__id',
            'width': '8rem',
            'render': function (data, type, row, meta) {
                if (type === 'display') {
                  return '<a href="/events/' + data.id + '">'+ data.display +'</a>';
                }
            },
          },
          {
            'data': 'event.artist',
            'name': 'event__artist__name',
            'width': '14rem',
            'render': function (data, type, row, meta) {
                if (type === 'display') {
                  return '<a href="/bands/' + data.id + '">'+ data.name +'</a>';
                }
            },
          },
          {
            'data': 'event.venue',
            'name': 'event__venue__name, event__venue__detail',
            'width': '12rem',
            'render': function (data, type, row, meta) {
                if (type === 'display') {
                  return '<a href="/venues/' + data.id + '">'+ data.name +'</a>';
                }
            },
          },
          {
            'data': 'event.venue.city',
            'name': 'event__venue__city__name, event__venue__state__abbrev, event__venue__country__name',
            'width': '12rem',
            'render': function (data, type, row, meta) {
              if (type === 'display') {
                return '<a href="/cities/' + data.id + '">'+ data.display +'</a>';
              };
            },
          },
          {
            'data': 'event.tour',
            'name': 'event__tour__name',
            'width': '12rem',
            'render': function (data, type, row, meta) {
              if (type === 'display') {
                return '<a href="/tours/' + data.id + '">'+ data.name +'</a>';
              }
            },
          },
          {'data': 'position', 'name': 'position', 'width': '6rem',},
          {'data': 'last', 'name': 'last', 'width': '1rem', },
          {'data': 'set_name', 'name': 'set_name', 'width': '4rem',},
          {
            'data': 'prev_song',
            'name': 'prev_song__name',
            'width': '12rem',
            'render': function (data, type, row, meta) {
                if (data != null) {
                  if (type === 'display') {
                    return '<a href="/songs/' + data.id + '">'+ data.name +'</a>';
                  }
                }
            },
          },
          {
            'data': 'next_song',
            'name': 'next_song__name',
            'width': '12rem',
            'render': function (data, type, row, meta) {
                if (data != null) {
                  if (type === 'display') {
                    return '<a href="/songs/' + data.id + '">'+ data.name +'</a>';
                  }
                }
            },
          },
          {'data': 'note', 'name': 'note'},
          {'data': 'event.public', 'name': 'event__public'},
        ]
      });

      var layout = getDatatableLayout({columns: [0,1,2], category: false});
      // for reasons unknown, an extra non-functioning searchbuilder button is added
      // this removes that single button.
      layout.topEnd.features.pop();

      new DataTable('#snippetTable', {
        layout: layout,
        serverSide: true,
        processing: true,
        ajax: {
          'url': '/api/v1/snippets/?snippet={{ song_info.id }}&format=datatables',
        },
        columns: [
          {
            'data': 'setlist.event.date',
            'name': 'setlist__event__id',
            'render': function (data, type, row, meta) {
              if (type === 'display') {
                return '<a href="/events/' + data.id + '">'+ data.display +'</a>';
              }
            },
          },
          {
            'data': 'setlist.song',
            'name': 'setlist__song__name',
            'render': function (data, type, row, meta) {
              if (type === 'display') {
                return '<a href="/songs/' + data.id + '">'+ data.name +'</a>';
              }
            },
          },
          {'data': 'note', 'name': 'note'},
        ]
      });
    });
  </script>
{% endblock content %}
