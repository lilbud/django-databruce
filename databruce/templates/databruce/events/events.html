{% extends "databruce/base.html" %}
{% block title %}
  Events
{% endblock title %}
{% block extrajs %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.19.0/clusterize.min.js"
          integrity="sha512-sCslfbDbPoJepZJxo6S3mdJwYYt0SX+C9G1SYez6/yGuXcPrZXM9tqZQMpujvMZlujVve98JSzimWbYAlQzvFQ=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.19.0/clusterize.min.css"
        integrity="sha512-8KLHxyeJ2I3BzL2ma1RZxwT1cc/U5Rz/uJg+G25tCrQ8sFfPz3MfJdKZegZDPijTxK2A3+b4kAXvzyK/OLLU5A=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer" />
{% endblock extrajs %}
{% block content %}
  <div class="col-12 col-xxl-8 mx-auto">
    <div class="d-flex justify-content-between mb-3">
      <div class="text-2xl">Events</div>
      <div class="float-end" id="year-select">
        <button class="btn btn-sm btn-primary dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false">{{ year }}</button>
        <ul class="dropdown-menu">
          {% for i in years %}
            <li>
              <a class="dropdown-item" href="{% url "events_year" year=i %}">{{ i }}</a>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <div class="card">
      <div class="card-body px-0">
        <div class="table-responsive">
          <table class="table table-hover display nowrap" id="eventTable">
            <thead>
              <tr class="custom">
                <th class="all">Date</th>
                <th class="d-none d-md-table-cell min-tablet-l">Setlist</th>
                <th class="d-none d-md-table-cell min-tablet-l">Band</th>
                <th class="d-none d-md-table-cell min-tablet-l">Venue</th>
                <th class="d-none d-md-table-cell min-tablet-l">Location</th>
                <th class="d-none d-md-table-cell min-tablet-l">Tour</th>
                <th class="d-none d-md-table-cell min-tablet-l">Detail</th>
                <th class="d-none d-md-table-cell min-tablet-l">Public</th>
              </tr>
            </thead>
            {% comment %} <tbody>
              {% for event in event_info %}
                <tr>
                  <td scope="row" class="text-nowrap" data-sort="{{ event.get_date }}" data-filter="{{ event.get_date }}">
                    <a href="{% url "event_details" id=event.id %}">{{ event.get_date }}</a>
                  </td>
                  <td class="icon text-center align-middle">
                    {% if event.setlist_certainty == "Confirmed" %}
                      <i class="bi bi-file-earmark-check d-none d-md-block" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Has Setlist"></i>
                      <div class="d-inline d-md-none">True</div>
                    {% else %}
                      <div class="d-inline d-md-none">False</div>
                    {% endif %}
                  </td>
                  <td class="text-nowrap">
                    <a href="{% url "band_details" id=event.artist.id %}">{{ event.artist.name }}</a>
                  </td>
                  <td class="text-nowrap">
                    <a href="{% url "venue_details" id=event.venue.id %}">{{ event.venue.get_name }}</a>
                  </td>
                  <td class="text-nowrap">
                    {% if event.venue.city %}
                      <a href="{% url "city_details" id=event.venue.city.id %}">{{ event.venue.city|default_if_none:"" }}</a>
                    {% endif %}
                  </td>
                  <td class="text-nowrap">
                    <a href="{% url "tour_details" id=event.tour.id %}">{{ event.tour.name|default_if_none:"" }}</a>
                  </td>
                  <td class="text-nowrap">{{ event.title|default_if_none:""|safe }}</td>
                  <td>{{ event.public|default_if_none:"" }}</td>
                </tr>
              {% endfor %}
            </tbody> {% endcomment %}
          </table>
        </div>
      </div>
    </div>
  </div>
  <script>
  $(document).ready(function () {
    
    function render(columns) {
      
    }

    var layout = getDatatableLayout({columns: [2,3,4,5,6,7], category: true});
    dtCategorySelect({layout: layout, column_idx: 7, values: [{'label': 'Public', 'value': 'true'}, {'label': 'Private', 'value': 'false'}]});
    const childRows = [];
    var table = new DataTable('#eventTable', {
      layout: layout,
      serverSide: true,
      processing: true,
      //responsive: false,
      //autoWidth: false,
      scrollY: '60vh',
      scrollX: true,
      ajax: {
        'url': '/api/v1/events/?year={{ year }}&format=datatables&keep=id,early_late,public',
      },
      columnDefs: [
        { targets: [1], orderable: false, searchable: false, className: 'text-center text-xs', width: '1rem'},
        { targets: [0], type: 'date', className: 'all text-wrap text-xs'},
        { targets: [1,2,3,4,5,6,7], className: 'text-wrap text-xs d-none d-md-table-cell min-tablet-l' },
        { targets: [-1], visible: false },
      ],
      columns: event_table_columns,
      /*initComplete: function(){
        var api = this.api();

        api.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
          var row = table.row(rowIdx);
          var childRow = $('<tr />').addClass('d-table-cell d-md-none child border-0');

          row.columns().every(function(column_idx, tableLoop, colLoop){
            var column = table.column(column_idx);
            var cell = table.cell(rowIdx, column_idx);

            if (column.visible() & !cell.node().classList.contains('all')) {
              var title = `${column.title().replace(":","")}:`
              var data = cell.render('display');

              var div = $('<div />').addClass("row res-child border-0 text-sm px-0");
              var columnCol = $('<div />').addClass("col-3 text-nowrap fw-bold mt-0");
              var dataCol = $('<div />').addClass("col text-nowrap mt-0");

              $(columnCol).html(title);
              $(dataCol).html(data);

              $(div).append(columnCol, dataCol);

              $(childRow).append(div);
            }
          });

          row.child(childRow).show();
        });
      },*/
    });

    /*
    $('#eventTable').on('click', 'tbody tr.dt-hasChild > td', function(){
      var child = $(this).closest('tr').next('tr.child');

      if ($(child).hasClass('d-none')) {
        $(child).removeClass('d-none');
      } else {
        $(child).addClass('d-none');
      }
    })*/

    $(function(){
      // bind change event to select
      $('#year_select').on('change', function () {
          var url = $(this).val() // get selected value
          if (url) { // require a URL
              window.location = url; // redirect
          }
          return false;
      });
    });

    $('#eventTable').on('click', 'tr td a', function(e) {
        // Check if the link is within a child row
        if ($(this).closest('tr').children('td.dtr-control')) {
            e.preventDefault();
        }
    });
  });
  </script>
{% endblock content %}
