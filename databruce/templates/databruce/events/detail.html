{% extends "databruce/base.html" %}
{% load filters %}
{% block title %}
  {{ event }} {{ event.artist }}
{% endblock title %}
{% block content %}
  <div class="row justify-content-center">
    <div class="col col-xl-8">
      <div class="row">
        <div class="col">
          <h6 class="float-end">
            <a class="btn btn-sm btn-secondary"
               role="button"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               data-bs-html="true"
               data-bs-title="<div>{{ prev_event }}<br>{{ prev_event.artist }}<br>{{ prev_event.venue }}</div>"
               href="{% url "event_details" id=prev_event.id %}">&lt; Prev</a>
            <a class="btn btn-sm btn-secondary"
               role="button"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               data-bs-html="true"
               data-bs-title="<div>{{ next_event }}<br>{{ next_event.artist }}<br>{{ next_event.venue }}</div>"
               href="{% url "event_details" id=next_event.id %}">Next &gt;</a>
          </h6>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col">
          <div class="card" id="eventInfo">
            <div class="card-body">
              <div class="d-flex flex-wrap">
                <div class="flex-grow-1 mb-4 mb-sm-0">
                  {% if event.title %}
                    <div class="text-nowrap mb-1">
                      <span id="title" class="fs-6 text-secondary-emphasis">{{ event.title }}</span>
                    </div>
                  {% endif %}
                  <div class="fs-4 mb-0">
                    <a class="pe-1 text-nowrap fw-semibold text-primary-500"
                       href="{% url "band_details" id=event.artist.id %}"
                       id="artist">{{ event.artist }}</a>
                    <span class="text-nowrap fw-bold text-light" id="date">{{ event.get_date }}</span>
                  </div>
                  {% if not event.date %}
                    <div class="text-nowrap">
                      <span class="text-secondary-emphasis small">This is a placeholder date, actual date unknown.</span>
                    </div>
                  {% endif %}
                  <div class="fs-5">
                    <a class="text-light" href="{% url "venue_details" id=event.venue.id %}">{{ event.venue }}</a>
                  </div>
                  <div class="badge-row text-wrap fs-6 mt-1">
                    {% if event.tour %}
                      <a href="{% url "tour_details" id=event.tour.id %}"><span class="badge bg-primary-700">{{ event.tour }}</span></a>
                    {% endif %}
                    {% if event.leg %}
                      <a href="{% url "leg_details" id=event.leg.id %}"><span class="badge bg-primary-700">{{ event.leg }}</span></a>
                    {% endif %}
                    {% if event.run %}
                      <a href="{% url "run_details" id=event.run.id %}"><span class="badge bg-primary-700">{{ event.run }}</span></a>
                    {% endif %}
                  </div>
                  <div class="badge-row my-2">
                    {% if event.brucebase_url %}
                      <a class="pe-1"
                         id="eventlink"
                         href="https://brucebase.wikidot.com/{{ event.id|brucebase_url }}">
                        <span class="badge text-bg-secondary eventlink">
                          <i class="bi bi-link-45deg pe-1"></i>
                          <span>Brucebase</span>
                        </span>
                      </a>
                    {% endif %}
                    {% if nugs %}
                      <a class="pe-1" id="eventlink" href="{{ nugs.url }}">
                        <span class="badge text-bg-secondary eventlink">
                          <i class="bi bi-headphones"></i>
                          <span>Nugs</span>
                        </span>
                      </a>
                    {% endif %}
                  </div>
                </div>
                <div>
                  {% if user.is_authenticated and event.publicity == true %}
                    <form method="post" id="userForm">
                      <input type="hidden" name="event" value="{{ event.id }}">
                      <input type="hidden" name="user" value="{{ user.id }}">
                      {% csrf_token %}
                      <div class="btn-group" role="group" aria-label="Basic example">
                        <button id="addshow-button"
                                type="submit"
                                name="submit"
                                class="btn btn-sm text-nowrap {% if event.id in user_shows %}active{% endif %}">
                          <span class="pe-1" id="star">
                            {% if event.id in user_shows %}
                              <i class="bi bi-star-fill"></i>
                            {% else %}
                              <i class="bi bi-star"></i>
                            {% endif %}
                          </span>
                          <span id="attended">
                            {% if event.id in user_shows %}
                              Attended
                            {% else %}
                              Attended?
                            {% endif %}
                          </span>
                        </button>
                        <button type="button"
                                id="userCount"
                                class="btn btn-sm {% if event.id in user_shows %}active{% endif %}">
                          {{ user_count|default_if_none:"0" }}
                        </button>
                      </div>
                    </form>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12 col-lg-8 mb-3 order-2 order-lg-1 pe-lg-2">
          <div class="row">
            <div class="col">
              {% if event.note %}
                <div class="col d-xs-block d-lg-none">
                  <div class="card mb-3" id="notes-card">
                    <div class="card-header">Event Notes</div>
                    <div class="card-body">{{ event.note|safe|linebreaks }}</div>
                  </div>
                </div>
              {% endif %}
              <div class="card">
                <div class="card-header">Setlist</div>
                <div class="card-body p-0 setlist">
                  {% regroup setlist by set_name as event_setlist %}
                  {% regroup notes by id.id as notes_list %}
                  <div class="table-responsive">
                    <table class="table table-hover display" id="setlistTable">
                      <thead>
                        <tr>
                          <th class="all text-center px-2">#</th>
                          <th class="all px-2">Song</th>
                          <th class="all text-center text-nowrap">
                            Gap
                            <i class="bi bi-info-circle-fill"
                               data-bs-toggle="tooltip"
                               data-bs-html="true"
                               data-bs-title="How many shows since a song was last played."></i>
                          </th>
                          <th class="all text-center">Tour</th>
                          <th class="all text-nowrap text-center">
                            Last Played
                            <i class="bi bi-info-circle-fill"
                               data-bs-toggle="tooltip"
                               data-bs-title="The last show a song was played at."></i>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for set in event_setlist %}
                          <tr class="text-center">
                            <td class="setHeader" colspan="5">{{ set.grouper }}</td>
                            <td class="setname d-none"></td>
                            <td class="setname d-none"></td>
                            <td class="setname d-none"></td>
                            <td class="setname d-none"></td>
                          </tr>
                          {% for song in set.list %}
                            <tr>
                              <td class="text-center px-2 songnum {% if song.position and song.position != song.set_name %}position {{ song.position|lower|cut:" " }}{% endif %}"
                                  {% if song.position %}data-bs-toggle="tooltip" data-bs-title="{{ song.position }}"{% endif %}>
                                {{ song.song_num }}
                              </td>
                              <td class="px-2">
                                <div class="row">
                                  <span class="text-nowrap fw-semibold">
                                    <a class="me-1" href="{% url "song_details" id=song.song.id %}">{{ song.song.name }}</a>
                                    {% if song.segue %}{{ song.separator }}{% endif %}
                                    {% if song.instrumental %}<span class="badge text-bg-success">Instrumental</span>{% endif %}
                                    {% if song.sign_request %}<span class="badge text-bg-danger">Sign Request</span>{% endif %}
                                  </span>
                                </div>
                                {% if notes_list %}
                                  <div class="row text-body-secondary mt-0.5" id="setlist_note">
                                    <small>
                                      {% for note in notes_list %}
                                        {% if note.grouper == song.id %}{{ note.list|setlist_note|safe }}{% endif %}
                                      {% endfor %}
                                    </small>
                                  </div>
                                {% endif %}
                              </td>
                              <td class="text-nowrap text-center">
                                {% if song.debut and not song.premiere %}
                                  <h6 class="mb-0">
                                    <span class="badge text-bg-danger">
                                      {% if song.last %}{{ song.last }},{% endif %}
                                    TD</span>
                                  </h6>
                                {% elif song.last >= 50 %}
                                  <h6 class="mb-0">
                                    <span class="badge text-bg-danger">{{ song.last }}, Bustout</span>
                                  </h6>
                                {% elif song.premiere %}
                                  First
                                {% else %}
                                  {{ song.last|default_if_none:"" }}
                                {% endif %}
                              </td>
                              <td class="text-nowrap text-center">
                                {% if song.tour_num %}{{ song.tour_num }} of {{ song.tour_total }}{% endif %}
                              </td>
                              <td class="text-nowrap text-center fw-semibold">
                                {% if song.ltp %}
                                  <a href="{% url "event_details" id=song.ltp.id %}">{{ song.ltp }}</a>
                                {% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4 order-2 ps-lg-2">
          <div class="row row-cols-1 g-3 mb-3">
            {% if event.note %}
              <div class="col d-none d-lg-block">
                <div class="card" id="notes-card">
                  <div class="card-header">Event Notes</div>
                  <div class="card-body">{{ event.note|safe|linebreaks }}</div>
                </div>
              </div>
            {% endif %}
            {% if musicians or bands %}
              <div class="col">
                <div class="card" id="onstage">
                  <div class="card-header">Performers</div>
                  <div class="card-body">
                    {% if musicians %}
                      <ul>
                        {% for member in musicians %}
                          <li>
                            <a href="{% url "relation_details" id=member.relation.id %}">{{ member.relation.name }}</a>
                          </li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                    {% if bands %}
                      {% regroup bands by band as bands_list %}
                      {% for band in bands_list %}
                        <a class="fw-semibold fs-6 text-reset text-body-light"
                           href="{% url "band_details" id=band.grouper.id %}">{{ band.grouper }}</a>
                        <ul>
                          {% for member in band.list %}
                            <li>
                              <a href="{% url "relation_details" id=member.relation.id %}">{{ member.relation.name }}</a>
                            </li>
                          {% endfor %}
                        </ul>
                      {% endfor %}
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endif %}
            {% if album_breakdown %}
              <div class="col">
                <div class="card">
                  <div class="card-header">
                    <span class="align-middle">Album Breakdown</span>
                    <button class="btn btn-sm btn-success float-end"
                            data-bs-toggle="modal"
                            data-bs-target="#album-breakdown-modal"
                            role="button">Breakdown</button>
                  </div>
                  <div class="card-body">
                    {% for album in album_breakdown %}
                      <div class="row pb-1" id="album-breakdown">
                        <div class="col">
                          <div class="progress-label">
                            <div class="pe-2 fw-semibold">{{ album.category }}</div>
                          </div>
                          <div class="progress d-flex flex-row justify-content-between"
                               role="progressbar"
                               aria-label="Basic example"
                               aria-valuenow="{{ album.num }}"
                               aria-valuemin="0"
                               aria-valuemax="{{ album.max }}">
                            <div class="progress-bar" style="width: {{ album.percent }}%">
                              <span class="song-count position-absolute end-0 fw-bold pe-4">{{ album.num }}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}
            {% if official or archive %}
              <div class="col">
                <div class="card" id="links-card">
                  <div class="card-header">Links</div>
                  <div class="card-body">
                    <ul class="ps-3">
                      {% if official %}
                        {% for rel in official %}
                          <li>
                            <a href="{% url "release_details" id=rel.release.id %}">{{ rel.release.name }} (Official Release)</a>
                          </li>
                        {% endfor %}
                      {% endif %}
                      {% if bootleg %}
                        <li>
                          <a href="https://www.springsteenlyrics.com/bootlegs.php?filter_date={{ event.date|date:"Y-m-d" }}&cmd=list&category=filter_date">View bootlegs on SpringsteenLyrics</a>
                        </li>
                      {% endif %}
                    </ul>
                    {% if archive %}
                      <h6>
                        Radio Nowhere @ Archive.org
                        <i class="bi bi-info-circle-fill"
                           data-bs-toggle="tooltip"
                           data-bs-html="true"
                           data-bs-title="An archive.org collection of Bruce bootlegs maintained by me"></i>
                      </h6>
                      <ul>
                        {% for rel in archive %}
                          <li>
                            <a href="https://archive.org/details/{{ rel.url }}">{{ rel.url }}</a>
                          </li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade"
       id="album-breakdown-modal"
       tabindex="-1"
       aria-labelledby="album-breakdown-modal-label"
       aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="album-breakdown-modal-label">Album Breakdown</h1>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% regroup setlist_unique by song.category as album_list %}
          {% for album in album_breakdown %}
            <ul class="list-group mb-3" id="breakdown">
              <li class="list-group-item active">
                <h5 class="mb-0">{{ album.category }}</h5>
              </li>
              {% for item in album_list %}
                {% if item.grouper == album.category %}
                  {% for song in item.list %}
                    <li class="list-group-item">
                      <span class="fw-semibold">
                        <a href="{% url "song_details" id=song.song.id %}">{{ song.song.name }}</a>
                      </span>
                      {% if song.song.original_artist != 'Bruce Springsteen' %}[{{ song.song.original_artist }}]{% endif %}
                    </li>
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </ul>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <script>
      $(document).ready(function() {
          // removes searchBuilder button, not needed for this.
          layout.topEnd.features[1].buttons.pop();
          layout.topStart = 'pageLength';

          new DataTable('#setlistTable', {
              layout: layout,
              autoWidth: false,
              paging: false,
              searching: false,
              
              ordering: false,
              columnDefs: [{ target: 0, width: '1%' }],
          });

          $('#userForm').submit(function(e) {
              e.preventDefault();
              var serializedData = $(this).serialize();

              $.ajax({
                type: "POST",
                url: "{% url 'add_show' %}",
                data:  serializedData,
                success: function(data) {
                  $("#userCount").text(data['count']);

                  if (data['action'] === 'added') {
                    $("#star").html('<i class="bi bi-star-fill"></i>');
                    $("#attended").text('Attended');
                    $("#addshow-button").addClass('active');
                    $("#userCount").addClass('active');

                  } else if (data['action'] === 'removed') {
                    $("#star").html('<i class="bi bi-star"></i>');
                    $("#attended").text('Attended?');
                    $("#addshow-button").removeClass('active');
                    $("#userCount").removeClass('active');
                  };
                },
              });
          });
      })
  </script>
{% endblock content %}
