{% extends "databruce/base.html" %}
{% load filters %}
{% block title %}
  Advanced Search Results
{% endblock title %}
{% block content %}
  <div class="col-12 col-xxl-8 mx-auto">
    <div class="text-2xl text-nowrap">Advanced Search Results</div>
    <div class="text-base mb-2">
      Click link below to copy a short url to these results (the links are very long and look awful).
    </div>
    <div id="short_url" class="mb-3">
      <button id="short-url" class="btn btn-link py-0 text-reset fw-semibold">Get Short URL</button>
      <span id="shortLink" class="d-none"></span>
      <button onclick="copy_to_clipboard()"
              class="btn btn-link py-0 d-none"
              id="copyButton">
        <i class="bi bi-copy"></i>
      </button>
    </div>
    <div class="card mb-3">
      <div class="card-body text-sm">
        <div id="row">
          <div class="d-flex flex-column">
            {% if song_results %}
              <span>
                <div class="pe-2 fw-semibold">Songs:</div>
                <div>
                  {% for result in song_results %}
                    <div class="d-flex flex-row">{{ result }}</div>
                    {% if not forloop.last %}
                      <div class="d-flex flex-row">
                        <span class="text-uppercase">{{ request.GET.conjunction }}</span>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </span>
            {% endif %}
            {% if results %}
              <span>
                {% for result in results %}
                  <div class="d-flex flex-row">
                    <div>{{ result }}</div>
                  </div>
                {% endfor %}
              </span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-body px-0">{% include "databruce/partials/event_table.html" with events=events %}</div>
    </div>
  </div>
  <script>
    function copy_to_clipboard() {
      var text = document.getElementById('shortLink').innerHTML;
      navigator.clipboard.writeText( text );
      console.log('copied URL')
    };

    $(document).ready(function () {
      new DataTable('#eventTable', {
        layout: getDatatableLayout([1,2,3,4]),
        columnDefs: [
          { targets: [1], width: '1rem', orderable: false },
        ],
      });

      $('button#short-url').click(function () {
        var received_data  = "{{ request.build_absolute_uri|safe }}"
        
        $.ajax({
            url: "/short_url/",
            type: "GET",
            data: {'url': received_data},
            cache: false,
            dataType: "json",
            success: function(resp) {
              $('#shortLink').removeClass('d-none');
              $('#shortLink').text(`${resp.short_url}`);
              $('#copyButton').removeClass('d-none');
            }
        });

        $('#short-url').prop('disabled', true);
      });
    });
  </script>
{% endblock content %}
